# 도메인 지식 템플릿 가이드

## 1. 개요

엔지니어의 **암묵적 경험 지식**을 구조화하여 AI Agent에 반영하기 위한 Excel 템플릿입니다.

### 템플릿 위치
```
analytics/templates/
├── expert_knowledge_template.xlsx        # 일반 도메인 지식
└── equipment_control_relationship_template.xlsx  # 설비 제어 관계
```

## 2. 일반 도메인 지식 템플릿

### 2.1 인과관계 시트

파라미터 간 인과관계를 정의합니다.

| 컬럼 | 설명 | 예시 |
|-----|------|------|
| 원인_파라미터 | 원인이 되는 PV | RF_POWER |
| 결과_파라미터 | 영향받는 PV | ETCH_RATE |
| 관계_유형 | 영향 방향 | 양의_상관 |
| 지연시간_초 | 영향 전파 시간 | 3 |
| 신뢰도 | 확신 정도 | HIGH |
| 근거 | 판단 근거 | 설비 메뉴얼 |

**입력 예시**:
```
RF_POWER → ETCH_RATE (양의_상관, 3초, HIGH, 설비 메뉴얼)
PRESSURE → UNIFORMITY (음의_상관, 2초, MEDIUM, 경험적 관찰)
```

### 2.2 알람원인 시트

알람의 근본 원인을 정의합니다.

| 컬럼 | 설명 | 예시 |
|-----|------|------|
| 알람_코드 | 알람 ID | ALM-001 |
| 원인_파라미터 | 근본 원인 PV | PRESSURE |
| 원인_조건 | 발생 조건 | HIGH (>10mTorr) |
| 우선순위 | 확인 순서 | 1 |
| 조치방법 | 권장 액션 | 펌프 상태 확인 |

### 2.3 선행지표 시트

이상 발생 전 변화하는 선행 지표를 정의합니다.

| 컬럼 | 설명 | 예시 |
|-----|------|------|
| 이상_유형 | 예측 대상 | ETCH_RATE_OOS |
| 선행_파라미터 | 선행 지표 PV | CHAMBER_TEMP |
| 선행_시간_분 | 사전 감지 시간 | 10 |
| 변화_패턴 | 변화 양상 | 상승 후 급락 |
| 임계값 | 경고 기준 | >80도 |

### 2.4 파라미터그룹 시트

관련 파라미터를 그룹핑합니다.

```
그룹_RF: [RF_POWER, RF_REFLECTED, MATCH_C1, MATCH_C2]
그룹_GAS: [GAS_FLOW, GAS_PRESSURE, MFC_VALVE]
그룹_TEMP: [CHUCK_TEMP, WALL_TEMP, DOME_TEMP]
```

### 2.5 불가능한관계 시트

물리적으로 불가능한 관계를 정의하여 오탐 방지에 활용합니다.

```
CHAMBER_A_TEMP ↔ CHAMBER_B_TEMP: 물리적 연결 없음
RF_POWER ↔ EXHAUST_PUMP: 직접 영향 없음
```

## 3. 설비 제어 관계 템플릿

### 3.1 설비마스터 시트

설비 기본 정보를 정의합니다.

| 컬럼 | 설명 | 예시 |
|-----|------|------|
| 설비ID | 고유 식별자 | EQ-ETCH-001 |
| 설비명 | 설비 이름 | ETCH #1 |
| 공정단계 | 공정 위치 | ETCH |
| 설비유형 | 설비 종류 | DRY_ETCH |
| 가동상태 | 운영 상태 | PRODUCTION |

### 3.2 Setpoint(설정값) 시트

레시피 설정값을 정의합니다.

| 컬럼 | 설명 | 예시 |
|-----|------|------|
| 설비ID | 소속 설비 | EQ-ETCH-001 |
| Setpoint_ID | 설정값 ID | SP-RF-POWER |
| 설정값명 | 표시 이름 | RF Power |
| 단위 | 측정 단위 | W |
| 정상범위_min | 하한 | 200 |
| 정상범위_max | 상한 | 1000 |

### 3.3 ProcessVariable(측정값) 시트

실시간 측정값을 정의합니다.

| 컬럼 | 설명 | 예시 |
|-----|------|------|
| 설비ID | 소속 설비 | EQ-ETCH-001 |
| PV_ID | 측정값 ID | PV-RF-POWER |
| 측정값명 | 표시 이름 | RF Power Actual |
| 단위 | 측정 단위 | W |
| 샘플링주기_ms | 수집 주기 | 100 |
| 응답지연_ms | 지연 시간 | 50 |

### 3.4 제어루프 시트

**핵심**: Setpoint → Controller → Actuator → PV 연결을 정의합니다.

```
제어루프 예시:
┌────────────┐    ┌────────────┐    ┌────────────┐    ┌────────────┐
│ SP-RF-POWER│───→│  PID-001   │───→│RF_GENERATOR│───→│PV-RF-POWER │
│ (설정값)    │    │ (컨트롤러) │    │ (액추에이터)│    │ (측정값)    │
└────────────┘    └────────────┘    └────────────┘    └────────────┘
```

### 3.5 PV간_인과관계 시트

**핵심**: 측정값 간의 물리적 인과관계를 정의합니다.

| Source_PV | Target_PV | 지연시간_초 | 영향방향 | 영향강도 |
|-----------|-----------|-----------|---------|---------|
| PV-PRESSURE | PV-RF-POWER | 1-2 | 양의상관 | HIGH |
| PV-RF-POWER | PV-ETCH-RATE | 3-5 | 양의상관 | VERY_HIGH |
| PV-TEMPERATURE | PV-ETCH-RATE | 2-4 | 양의상관 | MEDIUM |

### 3.6 품질영향관계 시트

PV가 최종 품질에 미치는 영향을 정의합니다.

```
PV-ETCH-RATE → CD (Critical Dimension): HIGH
PV-UNIFORMITY → THK Uniformity: VERY_HIGH
PV-SELECTIVITY → Defect Count: MEDIUM
```

### 3.7 알람원인매핑 시트

알람 코드와 근본원인 PV를 매핑합니다.

```
ALM-RF-HIGH → PV-RF-POWER (과출력)
ALM-PRESSURE-LOW → PV-PRESSURE (진공 누설)
ALM-TEMP-OOR → PV-TEMPERATURE (냉각수 이상)
```

### 3.8 데이터소스매핑 시트

실제 데이터 위치를 매핑합니다.

| PV_ID | 시스템 | 테이블명 | 컬럼명 |
|-------|-------|---------|-------|
| PV-RF-POWER | FDC | fdc_measurements | rf_power |
| PV-PRESSURE | FDC | fdc_measurements | chamber_pressure |
| PV-ETCH-RATE | SPC | spc_results | etch_rate |

## 4. 템플릿 생성 방법

### 일반 도메인 지식 템플릿
```bash
cd analytics
python scripts/create_expert_knowledge_template.py
# 생성: templates/expert_knowledge_template.xlsx
```

### 설비 제어 관계 템플릿
```bash
python scripts/create_equipment_control_template.py
# 생성: templates/equipment_control_relationship_template.xlsx
```

## 5. 템플릿 활용 방법

### 5.1 도메인 지식 로딩

```python
from relationship_discovery import ExpertKnowledgeLoader

loader = ExpertKnowledgeLoader()
knowledge = loader.load('templates/expert_knowledge_template.xlsx')

# 인과관계 조회
print(knowledge.causal_relationships)

# 알람 원인 조회
print(knowledge.get_alarm_causes('ALM-001'))
```

### 5.2 AI Agent 프롬프트 생성

```python
# 도메인 지식 기반 시스템 프롬프트 생성
prompt = loader.generate_agent_prompt()
print(prompt)
```

**생성되는 프롬프트 예시**:
```
당신은 반도체 공정 전문가입니다.

## 알려진 인과관계
- RF_POWER가 증가하면 3초 후 ETCH_RATE가 증가합니다 (신뢰도: HIGH)
- PRESSURE가 증가하면 2초 후 UNIFORMITY가 감소합니다 (신뢰도: MEDIUM)

## 알람 원인
- ALM-001: PRESSURE 이상 (HIGH >10mTorr)
- ALM-002: RF_POWER 불안정

## 선행지표
- ETCH_RATE_OOS 발생 10분 전 CHAMBER_TEMP가 상승 후 급락합니다
```

## 6. 작성 가이드라인

### DO (권장)
- 확실한 관계만 HIGH 신뢰도로 표시
- 근거를 명확하게 기록 (메뉴얼, SOP, 실험 결과 등)
- 지연시간은 범위로 기록 (예: 2-5초)
- 주기적으로 검토 및 업데이트

### DON'T (지양)
- 추측만으로 관계 정의
- 신뢰도를 무조건 HIGH로 표시
- 근거 없이 작성
- 한 번 작성 후 방치

## 7. 관계 검증 워크플로우

```
1. 데이터 분석으로 관계 발견 (자동)
      ↓
2. 템플릿의 기존 지식과 비교
      ↓
3. 일치하면 → 검증됨 (verified)
   불일치하면 → 전문가 검토 필요 (pending)
      ↓
4. 전문가 검토 후 확정/거부
      ↓
5. 온톨로지에 반영
```
