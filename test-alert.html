<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alert System Quick Test</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e293b;
      color: #e2e8f0;
      min-height: 100vh;
      padding: 20px;
    }
    .container { max-width: 800px; margin: 0 auto; }
    h1 { margin-bottom: 20px; color: #fff; }
    .card {
      background: #334155;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .card h3 { margin-bottom: 15px; color: #94a3b8; font-size: 14px; text-transform: uppercase; }
    .status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 15px;
    }
    .status.connected { background: rgba(34, 197, 94, 0.2); }
    .status.disconnected { background: rgba(239, 68, 68, 0.2); }
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .status.connected .status-dot { background: #22c55e; animation: pulse 2s infinite; }
    .status.disconnected .status-dot { background: #ef4444; }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 5px; color: #94a3b8; font-size: 14px; }
    .input-group input {
      width: 100%;
      padding: 10px;
      border: 1px solid #475569;
      border-radius: 6px;
      background: #1e293b;
      color: #fff;
      font-size: 14px;
    }
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-critical { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.5); }
    .btn-critical:hover { background: rgba(239, 68, 68, 0.3); }
    .btn-warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; border: 1px solid rgba(245, 158, 11, 0.5); }
    .btn-warning:hover { background: rgba(245, 158, 11, 0.3); }
    .btn-info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.5); }
    .btn-info:hover { background: rgba(59, 130, 246, 0.3); }
    .btn-secondary { background: #475569; color: #fff; }
    .btn-secondary:hover { background: #64748b; }
    .log-container {
      background: #0f172a;
      border-radius: 6px;
      padding: 15px;
      height: 300px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 12px;
    }
    .log-entry { padding: 3px 0; border-bottom: 1px solid #1e293b; }
    .log-time { color: #64748b; }
    .log-success { color: #22c55e; }
    .log-error { color: #ef4444; }
    .log-alert { color: #fbbf24; }
    .log-info { color: #94a3b8; }
    .alert-list { max-height: 200px; overflow-y: auto; }
    .alert-item {
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 6px;
      border-left: 4px solid;
    }
    .alert-item.critical { background: rgba(239, 68, 68, 0.1); border-color: #ef4444; }
    .alert-item.warning { background: rgba(245, 158, 11, 0.1); border-color: #f59e0b; }
    .alert-item.info { background: rgba(59, 130, 246, 0.1); border-color: #3b82f6; }
    .alert-item .severity { font-size: 11px; font-weight: 600; text-transform: uppercase; }
    .alert-item .message { margin-top: 5px; }
    .alert-item .meta { margin-top: 5px; font-size: 11px; color: #64748b; }
    .sound-controls { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; }
    .toggle {
      position: relative;
      width: 50px;
      height: 26px;
      background: #475569;
      border-radius: 13px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle.active { background: #3b82f6; }
    .toggle::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle.active::after { transform: translateX(24px); }
  </style>
</head>
<body>
  <div class="container">
    <h1>Alert System Quick Test</h1>

    <!-- Connection Status -->
    <div class="card">
      <h3>Connection Status</h3>
      <div id="connection-status" class="status disconnected">
        <div class="status-dot"></div>
        <span id="status-text">Disconnected</span>
      </div>
      <div class="input-group">
        <label>API URL</label>
        <input type="text" id="api-url" value="http://localhost:8000">
      </div>
      <div class="btn-group">
        <button class="btn btn-info" onclick="connect()">Connect WebSocket</button>
        <button class="btn btn-secondary" onclick="disconnect()">Disconnect</button>
      </div>
    </div>

    <!-- Sound Controls -->
    <div class="card">
      <h3>Sound Controls</h3>
      <div class="sound-controls">
        <span>Alert Sound</span>
        <div id="sound-toggle" class="toggle active" onclick="toggleSound()"></div>
        <button class="btn btn-secondary" onclick="initAudio()">Initialize Audio</button>
      </div>
      <div class="btn-group">
        <button class="btn btn-critical" onclick="testSound('critical')">Critical Sound</button>
        <button class="btn btn-warning" onclick="testSound('warning')">Warning Sound</button>
        <button class="btn btn-info" onclick="testSound('info')">Info Sound</button>
      </div>
    </div>

    <!-- Send Test Alerts -->
    <div class="card">
      <h3>Send Test Alerts</h3>
      <div class="btn-group">
        <button class="btn btn-critical" onclick="sendAlert('CRITICAL')">Send CRITICAL</button>
        <button class="btn btn-warning" onclick="sendAlert('WARNING')">Send WARNING</button>
        <button class="btn btn-info" onclick="sendAlert('INFO')">Send INFO</button>
      </div>
    </div>

    <!-- Received Alerts -->
    <div class="card">
      <h3>Received Alerts (<span id="alert-count">0</span>)</h3>
      <div id="alert-list" class="alert-list"></div>
    </div>

    <!-- Console Log -->
    <div class="card">
      <h3>Console Log</h3>
      <div id="log-container" class="log-container"></div>
    </div>
  </div>

  <script>
    // State
    let ws = null;
    let soundEnabled = true;
    let audioContext = null;
    let alerts = [];

    // Logging
    function log(type, message) {
      const container = document.getElementById('log-container');
      const time = new Date().toLocaleTimeString('ko-KR', { hour12: false }) + '.' +
                   String(new Date().getMilliseconds()).padStart(3, '0');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-${type}">${message}</span>`;
      container.insertBefore(entry, container.firstChild);
    }

    // Audio
    function initAudio() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        log('success', 'Audio initialized successfully');
        playBeep(440, 0.3, 'sine');
      } catch (e) {
        log('error', 'Audio initialization failed: ' + e);
      }
    }

    function playBeep(freq, duration, type) {
      if (!soundEnabled || !audioContext) return;
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain);
      gain.connect(audioContext.destination);
      osc.frequency.value = freq;
      osc.type = type;
      gain.gain.setValueAtTime(0.5, audioContext.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
      osc.start(audioContext.currentTime);
      osc.stop(audioContext.currentTime + duration);
    }

    function testSound(severity) {
      if (!audioContext) initAudio();
      switch(severity) {
        case 'critical':
          playBeep(880, 0.15, 'square');
          setTimeout(() => playBeep(880, 0.15, 'square'), 200);
          setTimeout(() => playBeep(880, 0.15, 'square'), 400);
          break;
        case 'warning':
          playBeep(660, 0.2, 'triangle');
          setTimeout(() => playBeep(660, 0.2, 'triangle'), 300);
          break;
        case 'info':
          playBeep(440, 0.3, 'sine');
          break;
      }
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      document.getElementById('sound-toggle').classList.toggle('active', soundEnabled);
      log('info', 'Sound ' + (soundEnabled ? 'enabled' : 'disabled'));
    }

    // WebSocket
    function connect() {
      const apiUrl = document.getElementById('api-url').value;
      const wsUrl = apiUrl.replace('http://', 'ws://').replace('https://', 'wss://');
      const clientId = 'test_' + Date.now();

      log('info', 'Connecting to ' + wsUrl + '/api/realtime/ws/' + clientId);

      try {
        ws = new WebSocket(wsUrl + '/api/realtime/ws/' + clientId);

        ws.onopen = () => {
          updateStatus(true);
          log('success', 'WebSocket connected!');

          // Subscribe to alerts
          ws.send(JSON.stringify({ type: 'subscribe', channel: 'alerts' }));
          ws.send(JSON.stringify({ type: 'subscribe', channel: 'anomalies' }));
          log('info', 'Subscribed to alerts and anomalies channels');
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            log('info', 'Received: ' + data.type);

            if (data.type === 'alert' || data.type === 'anomaly') {
              addAlert(data);
              testSound((data.severity || 'info').toLowerCase());
            }
          } catch (e) {
            log('error', 'Parse error: ' + e);
          }
        };

        ws.onclose = () => {
          updateStatus(false);
          log('error', 'WebSocket disconnected');
        };

        ws.onerror = (e) => {
          log('error', 'WebSocket error');
        };
      } catch (e) {
        log('error', 'Connection failed: ' + e);
      }
    }

    function disconnect() {
      if (ws) {
        ws.close();
        ws = null;
      }
    }

    function updateStatus(connected) {
      const el = document.getElementById('connection-status');
      const text = document.getElementById('status-text');
      el.className = 'status ' + (connected ? 'connected' : 'disconnected');
      text.textContent = connected ? 'Connected' : 'Disconnected';
    }

    // Alerts
    function addAlert(data) {
      const severity = (data.severity || 'INFO').toLowerCase();
      const alert = {
        id: Date.now(),
        severity: data.severity || 'INFO',
        message: data.message || 'No message',
        equipment: data.equipment_id || 'N/A',
        time: new Date().toLocaleTimeString('ko-KR', { hour12: false })
      };

      alerts.unshift(alert);
      if (alerts.length > 20) alerts.pop();

      renderAlerts();
      log('alert', `[${alert.severity}] ${alert.message}`);
    }

    function renderAlerts() {
      const container = document.getElementById('alert-list');
      document.getElementById('alert-count').textContent = alerts.length;

      container.innerHTML = alerts.map(a => `
        <div class="alert-item ${a.severity.toLowerCase()}">
          <div class="severity">${a.severity}</div>
          <div class="message">${a.message}</div>
          <div class="meta">${a.equipment} | ${a.time}</div>
        </div>
      `).join('');
    }

    // Send alert via API
    async function sendAlert(severity) {
      const apiUrl = document.getElementById('api-url').value;
      const params = new URLSearchParams({
        alert_type: 'test',
        equipment_id: 'TEST-001',
        severity: severity,
        message: `[Test] ${severity} alert at ${new Date().toLocaleTimeString()}`
      });

      log('info', 'Sending ' + severity + ' alert...');

      try {
        const response = await fetch(`${apiUrl}/api/realtime/broadcast/alert?${params}`, {
          method: 'POST'
        });

        if (response.ok) {
          const data = await response.json();
          log('success', 'Alert sent (recipients: ' + data.recipients + ')');
        } else {
          log('error', 'Send failed: ' + response.status);
        }
      } catch (e) {
        log('error', 'Send error: ' + e);
      }
    }

    // Init
    log('info', 'Test page loaded. Click "Connect WebSocket" to start.');
  </script>
</body>
</html>
